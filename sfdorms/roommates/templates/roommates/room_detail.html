{% extends "base.html" %}
{% block content %}
{% load static %}
{% load widget_tweaks %}
<div class="container mt-4">
    <h2>{{ room.name }} 's Room</h2>

    <!-- To-Do List -->
     <ul class="list-group mb-4" id="todo-list">
        {% for item in room.todos.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{  item.text }}</strong><br>
                    <small class="text-muted">Added by: {{ item.created_by.username }}</small>
                </div>
                <div>
                    <a href="{% url 'edit_todo' room.id item.id %}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="{% url 'delete_todo' room.id item.id %}" class="btn btn-sm btn-danger">Delete</a>
                </div>
                <div class="mt-2 ps-3">
                    <div id="comments-{{ item.id }}">
                        <strong>Comments</strong>
                        {% for comment in item.comments.all %}
                            {% include "roommates/comment.html" with comment=comment %}
                        {% empty %}
                            <div class="text-muted">No comments yet.</div>
                        {% endfor %}
                    </div>

                    <form class="add-comment-form mt-2" data-task-id="{{ item.id }}">
                        {% csrf_token %}
                        <input type="text" name="text" class="form-control form-control-sm mb-1" placeholder="Add a comment">
                        <button type="submit" class="btn btn-sm btn-secondary">Submit</button>
                    </form>
                </div>
            </li>
        {% empty %}
            <li class="list-group-item text-muted">No tasks yet.</li>
        {% endfor %}
     </ul>
    
    <!-- Add Task -->
     <button id="add-task-btn" type="submit" class="btn btn-primary">Add Task</button>

     <form method="post" action="{% url 'add_todo' room.id %}" class="mb-3" id="task-form" style="display: none; margin-top: 10px;">
        {% csrf_token %}
        <input type="text" name="text" placeholder="Enter task" required>
        <button type="submit" class="btn btn-success">Submit</button>        
     </form>

    <!-- Member Management -->
     <h5>Room Members:</h5>
     <ul class="list-group mb-3">
        {% for member in room.member.all %}
            <li class="list-group-item d-flex justify-content-between">
                {{ member.username }}
                {% if user == room.owner %}
                    <form method="post" action="{% url 'remove_member' room.id member.id %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                    </form>
                {% endif %}
            </li>
        {% endfor %}
     </ul>

     <form method="post" action="{% url 'add_member' room.id %}">
        {% csrf_token %}
        <input type="text" name="username" class="form-control mb-2" placeholder="Add member by username">
        <button type="submit" class="btn btn-success">Add Member</button>
     </form>
</div>

<script>
    document.getElementById("add-task-btn").addEventListener("click", function() {
        const form = document.getElementById("task-form");
        form.style.display = form.style.display === "none" ? "block" : "none";
    });

    document.querySelectorAll(".add-comment-form").forEach(form => {
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            const taskId = this.getAttribute("data-task-id");
            const formData = new FormData(this);

            fetch(`/todo/${taskId}/add_comment/`, {
                method: "POST",
                headers: {
                    'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const commentsDiv = document.getElementById(`comments-${taskId}`);
                    commentsDiv.insertAdjacentHTML("beforeend", data.html);
                    this.reset();
                }
            });
        }) ;
    });
</script>
<script src="{% static 'js/delete_comment.js' %}"></script>
{% endblock %}